name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg libsndfile1

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install ffmpeg libsndfile

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[test,segmentation]

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

    - name: Upload coverage reports to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  homebrew-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Patch formula for PR testing
      run: |
        FORMULA=tagger.rb

        if [[ $GITHUB_REF != refs/heads/main ]]; then
          echo "Patching formula for PR testing on $GITHUB_REF"
          # Use --always to fallback to commit hash if no tags exist
          HASH=$(git describe --always --tags HEAD | tr -d '\n')
          export HASH
          export URL=https://github.com/delphinus/homebrew-tagger/tarball/$HASH
          SHA=$(curl -L "$URL" | shasum -a256 | cut -wf1)
          export SHA
          perl -i -pe 's,(?<=^  url ").*(?="$),$ENV{URL},' $FORMULA
          perl -i -pe 's,(?<=^  sha256 ").*(?="$),$ENV{SHA},' $FORMULA
          # Add version field after license line if not present, or update if present
          if grep -q '^  version ' $FORMULA; then
            perl -i -pe 's,(?<=^  version ").*(?="$),$ENV{HASH},' $FORMULA
          else
            perl -i -pe 's,^(  license .*)$,$1\n  version "$ENV{HASH}",' $FORMULA
          fi

          echo "Patched formula:"
          grep -A2 'url "' $FORMULA
          grep 'sha256 "' $FORMULA
          grep 'version "' $FORMULA || echo "(no version field)"
        fi

    - name: Setup Homebrew tap
      run: |
        # Create a local tap for testing
        mkdir -p $(brew --repository)/Library/Taps/delphinus/homebrew-tagger
        cp -r . $(brew --repository)/Library/Taps/delphinus/homebrew-tagger/

    - name: Install tagger via Homebrew
      run: |
        brew install --build-from-source delphinus/tagger/tagger

    - name: Verify tagger installation
      run: |
        tagger --version
        which tagger

        # Verify version matches expected version from formula
        # For PR builds, the formula has a 'version' field with commit hash
        # For main branch, extract version from URL
        if grep -q '^  version ' tagger.rb; then
          # PR build - version field exists, skip version check (commit hash != semver)
          echo "✓ PR build detected - skipping version number check"
        else
          # Main branch build - extract from URL
          EXPECTED_VERSION=$(grep -E '^\s+url' tagger.rb | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | sed 's/v//')
          ACTUAL_VERSION=$(tagger --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          echo "Expected version: ${EXPECTED_VERSION}"
          echo "Actual version: ${ACTUAL_VERSION}"

          if [ "${EXPECTED_VERSION}" != "${ACTUAL_VERSION}" ]; then
            echo "❌ Version mismatch!"
            echo "Formula specifies v${EXPECTED_VERSION} but tagger reports ${ACTUAL_VERSION}"
            exit 1
          fi

          echo "✓ Version check passed: ${ACTUAL_VERSION}"
        fi

    - name: Check installed Python modules
      run: |
        echo "=== Checking installed modules in Homebrew virtualenv ==="
        # Find the tagger installation directory
        TAGGER_CELLAR=$(brew --prefix tagger)
        TAGGER_VENV="${TAGGER_CELLAR}/libexec"

        if [ -f "${TAGGER_VENV}/bin/python" ]; then
          echo "Tagger installation: ${TAGGER_CELLAR}"
          echo "Python virtualenv: ${TAGGER_VENV}"
          ${TAGGER_VENV}/bin/python -c "import sys; print('Python version:', sys.version)"
          echo ""
          echo "=== Checking critical dependencies ==="
          ${TAGGER_VENV}/bin/python -c "import librosa; print('✓ librosa:', librosa.__version__)"
          ${TAGGER_VENV}/bin/python -c "import numpy; print('✓ numpy:', numpy.__version__)"
          ${TAGGER_VENV}/bin/python -c "import tqdm; print('✓ tqdm:', tqdm.__version__)"
          ${TAGGER_VENV}/bin/python -c "import mutagen; print('✓ mutagen: installed')"
          ${TAGGER_VENV}/bin/python -c "import pydantic; print('✓ pydantic:', pydantic.__version__)"
          ${TAGGER_VENV}/bin/python -c "import yaml; print('✓ pyyaml: installed')"
          echo ""
          echo "=== Segmentation dependencies ==="
          ${TAGGER_VENV}/bin/python -c "import soundfile; print('✓ soundfile:', soundfile.__version__)"
          ${TAGGER_VENV}/bin/python -c "import scipy; print('✓ scipy:', scipy.__version__)"
          ${TAGGER_VENV}/bin/python -c "import sklearn; print('✓ scikit-learn:', sklearn.__version__)"
          ${TAGGER_VENV}/bin/python -c "import numba; print('✓ numba:', numba.__version__)"
          echo ""
          echo "=== All required modules are installed correctly ==="
        else
          echo "Error: Could not find tagger virtualenv at ${TAGGER_VENV}"
          exit 1
        fi

    - name: Test basic tagger functionality
      run: |
        tagger --help

  all-checks-passed:
    needs: [test, homebrew-test]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "All checks passed successfully!"
