name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.6)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate version format
      run: |
        if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.Y.Z (e.g., 1.2.6)"
          exit 1
        fi

    - name: Check if version already exists
      run: |
        if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
          echo "Error: Version v${{ inputs.version }} already exists"
          exit 1
        fi

    - name: Update version in setup.py, tagger, and man pages
      run: |
        sed -i 's/version="[0-9.]*"/version="${{ inputs.version }}"/' setup.py
        sed -i 's/__version__ = "[0-9.]*"/__version__ = "${{ inputs.version }}"/' tagger
        sed -i 's/^\.TH TAGGER 1 "\(.*\)" "tagger [0-9.]*"/\.TH TAGGER 1 "\1" "tagger ${{ inputs.version }}"/' man/tagger.1
        sed -i 's/^\.TH TAGGER 1 "\(.*\)" "tagger [0-9.]*"/\.TH TAGGER 1 "\1" "tagger ${{ inputs.version }}"/' man/ja/tagger.1
        git diff setup.py tagger man/tagger.1 man/ja/tagger.1

    - name: Create and merge version bump PR
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        BRANCH_NAME="release/v${{ inputs.version }}"
        git checkout -b "${BRANCH_NAME}"
        git add setup.py tagger man/tagger.1 man/ja/tagger.1
        git commit -m "chore: bump version to ${{ inputs.version }}"
        git push origin "${BRANCH_NAME}"

        # Create PR
        PR_URL=$(gh pr create \
          --title "chore: bump version to ${{ inputs.version }}" \
          --body "Bump version to ${{ inputs.version }} for release" \
          --base main \
          --head "${BRANCH_NAME}")

        echo "Created PR: ${PR_URL}"
        PR_NUMBER=$(echo "${PR_URL}" | grep -o '[0-9]*$')
        echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV

        # Wait for CI to complete
        echo "Waiting for CI checks to complete..."
        sleep 30

        while true; do
          STATUS=$(gh pr checks "${PR_NUMBER}" --json state -q '.[].state' | sort -u)

          if echo "${STATUS}" | grep -q "FAILURE"; then
            echo "‚ùå CI checks failed"
            gh pr checks "${PR_NUMBER}"
            exit 1
          fi

          if [ "$(echo "${STATUS}" | grep -v "SUCCESS" | wc -l)" -eq 0 ]; then
            echo "‚úÖ All CI checks passed"
            break
          fi

          echo "Still waiting for checks... (current: ${STATUS})"
          sleep 30
        done

        # Merge the PR
        gh pr merge "${PR_NUMBER}" --squash --delete-branch
        echo "‚úÖ Version bump PR merged"

    - name: Create and push tag
      run: |
        # Fetch latest main after merge
        git checkout main
        git pull origin main

        # Create and push tag
        git tag "v${{ inputs.version }}"
        git push origin "v${{ inputs.version }}"
        echo "‚úÖ Created and pushed tag v${{ inputs.version }}"

    - name: Create GitHub release
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        gh release create "v${{ inputs.version }}" \
          --title "v${{ inputs.version }}" \
          --generate-notes
        echo "‚úÖ Created GitHub release v${{ inputs.version }}"

    - name: Update Homebrew formula
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # Calculate SHA256 of the release tarball
        TARBALL_URL="https://github.com/delphinus/homebrew-tagger/archive/refs/tags/v${{ inputs.version }}.tar.gz"
        SHA256=$(curl -sL "${TARBALL_URL}" | shasum -a 256 | awk '{print $1}')
        echo "Calculated SHA256: ${SHA256}"

        # Update formula
        sed -i "s|url \"https://github.com/delphinus/homebrew-tagger/archive/refs/tags/v[0-9.]*\.tar\.gz\"|url \"${TARBALL_URL}\"|" tagger.rb
        # Only update the main formula SHA256 (in the first 20 lines, with 2-space indent)
        # This avoids changing resource SHA256s which come later in the file
        sed -i '1,20s/^  sha256 "[a-f0-9]*"$/  sha256 "'"${SHA256}"'"/' tagger.rb

        # Create formula update PR
        FORMULA_BRANCH="formula/v${{ inputs.version }}"
        git checkout -b "${FORMULA_BRANCH}"
        git add tagger.rb
        git commit -m "chore: update tagger.rb with v${{ inputs.version }} SHA256"
        git push origin "${FORMULA_BRANCH}"

        # Create PR
        FORMULA_PR_URL=$(gh pr create \
          --title "chore: update tagger.rb with v${{ inputs.version }} SHA256" \
          --body "Update Homebrew formula for v${{ inputs.version }} release with SHA256: \`${SHA256}\`" \
          --base main \
          --head "${FORMULA_BRANCH}")

        echo "Created formula PR: ${FORMULA_PR_URL}"
        FORMULA_PR_NUMBER=$(echo "${FORMULA_PR_URL}" | grep -o '[0-9]*$')

        # Wait for CI to complete
        echo "Waiting for formula PR CI checks to complete..."
        sleep 30

        while true; do
          STATUS=$(gh pr checks "${FORMULA_PR_NUMBER}" --json state -q '.[].state' | sort -u)

          if echo "${STATUS}" | grep -q "FAILURE"; then
            echo "‚ùå Formula PR CI checks failed"
            gh pr checks "${FORMULA_PR_NUMBER}"
            exit 1
          fi

          if [ "$(echo "${STATUS}" | grep -v "SUCCESS" | wc -l)" -eq 0 ]; then
            echo "‚úÖ All formula PR CI checks passed"
            break
          fi

          echo "Still waiting for checks... (current: ${STATUS})"
          sleep 30
        done

        # Merge the formula PR
        gh pr merge "${FORMULA_PR_NUMBER}" --squash --delete-branch
        echo "‚úÖ Formula PR merged"

    - name: Release Summary
      run: |
        echo "‚úÖ Release v${{ inputs.version }} completed successfully!"
        echo ""
        echo "üì¶ Tag: v${{ inputs.version }}"
        echo "üöÄ Release: https://github.com/delphinus/homebrew-tagger/releases/tag/v${{ inputs.version }}"
        echo "üç∫ Homebrew formula updated and merged"
