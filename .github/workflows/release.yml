name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.6)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate version format
      run: |
        if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version must be in format X.Y.Z (e.g., 1.2.6)"
          exit 1
        fi

    - name: Check if version already exists
      run: |
        if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
          echo "Error: Version v${{ inputs.version }} already exists"
          exit 1
        fi

    - name: Update version in setup.py, tagger, and man pages
      run: |
        sed -i 's/version="[0-9.]*"/version="${{ inputs.version }}"/' setup.py
        sed -i 's/__version__ = "[0-9.]*"/__version__ = "${{ inputs.version }}"/' tagger
        sed -i 's/^\.TH TAGGER 1 "\(.*\)" "tagger [0-9.]*"/\.TH TAGGER 1 "\1" "tagger ${{ inputs.version }}"/' man/tagger.1
        sed -i 's/^\.TH TAGGER 1 "\(.*\)" "tagger [0-9.]*"/\.TH TAGGER 1 "\1" "tagger ${{ inputs.version }}"/' man/ja/tagger.1
        git diff setup.py tagger man/tagger.1 man/ja/tagger.1

    - name: Create version bump PR
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        BRANCH_NAME="release/v${{ inputs.version }}"
        git checkout -b "${BRANCH_NAME}"
        git add setup.py tagger man/tagger.1 man/ja/tagger.1
        git commit -m "chore: bump version to ${{ inputs.version }}"
        git push origin "${BRANCH_NAME}"

        # Create PR and wait for it to be created
        PR_URL=$(gh pr create \
          --title "chore: bump version to ${{ inputs.version }}" \
          --body "Bump version to ${{ inputs.version }} for release" \
          --base main \
          --head "${BRANCH_NAME}")

        echo "Created PR: ${PR_URL}"
        echo "PR_URL=${PR_URL}" >> $GITHUB_ENV

        # Note: Tag creation will be done manually after version bump PR is merged

    - name: Release Summary
      run: |
        echo "‚úÖ Version bump PR created for v${{ inputs.version }}"
        echo ""
        echo "üìù Version bump PR: ${PR_URL}"
        echo ""
        echo "Next steps (manual):"
        echo "  1. Wait for version bump PR CI to pass and merge it"
        echo "  2. Create git tag: git tag v${{ inputs.version }} && git push origin v${{ inputs.version }}"
        echo "  3. Create GitHub release: gh release create v${{ inputs.version }} --generate-notes"
        echo "  4. Update Homebrew formula with the release SHA256"
