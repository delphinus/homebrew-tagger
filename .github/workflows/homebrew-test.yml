name: Homebrew Install Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-homebrew-install:
    runs-on: macos-latest  # ARM64 (Apple Silicon)
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4

    - name: Set up Homebrew and install from local formula
      run: |
        set -eux

        # Disable features to speed up installation
        export HOMEBREW_NO_INSTALL_CLEANUP=1
        export HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK=1
        export HOMEBREW_NO_INSTALL_FROM_API=1

        sw_vers # show macOS version

        FORMULA=tagger.rb

        if [[ $GITHUB_REF = refs/heads/main ]]; then
          echo "Building on the latest tag"
        else
          echo "Building on $GITHUB_REF"
          HASH=$(git describe --tags HEAD | tr -d '\n')
          export HASH
          export URL=https://github.com/delphinus/homebrew-tagger/tarball/$HASH
          SHA=$(curl -L "$URL" | shasum -a256 | cut -wf1)
          export SHA
          perl -i -pe 's,(?<=^  url ").*(?="$),$ENV{URL},' $FORMULA
          perl -i -pe 's,(?<=^  sha256 ").*(?="$),$ENV{SHA},' $FORMULA
        fi

        TAP=local/tagger

        # Configure git for brew tap-new
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

        brew update

        # Create local tap and copy formula
        brew tap-new $TAP
        cp $FORMULA "$(brew --repo $TAP)/Formula/"

        # Install from local tap
        brew install -v $TAP/tagger

    - name: Test tagger installation
      run: |
        # Check that tagger is installed
        which tagger

        # Check that tagger can run
        tagger --help

        # Check version
        brew info local/tagger/tagger

    - name: Test tagger functionality
      run: |
        # Create a test directory
        mkdir -p test_audio
        cd test_audio

        # Test basic functionality (dry-run mode)
        echo "Testing tagger in dry-run mode..."

        # tagger should work even without audio files
        tagger || true
